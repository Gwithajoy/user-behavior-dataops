services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    environment: 
      ZOOKEEPER_CLIENT_PORT: 2181
    ports: ["2181:2181"]


kafka:
  image: confluentinc/cp-kafka:7.6.1
  depends_on: [ zookeeper ]
  ports: ["9092:9092"]
  environment:
    KAFKA_BORKER_ID: 1
    KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
    KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
    KAFAK_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092, PLAINTEXT_HOST://localhost:9092
    KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
    KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1


mysql:
    image: mysql:8.0
    ports: [ "3306:3306" ]
    environment:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: ${MYSQL_DB}
        MYSQL_USER: ${MYSQL_USER}
        MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - ./db/mysql/init:/docker-entrypoint-initdb.db


mongo:
    image: mongo:7
    ports: [ "27017:27017" ]


airflow:
    image: apache/airflow:2.10.2
    depends_on: [mysql]
    environment:
        AIRFLOW_CORE_LOAD_EXAMPLES: "False"
        AIRFLOW_CORE_EXECUTOR: LocalExecutor
    volumes:
        - ./airflow/dags:/opt/airflow/dags
    command:
        bash -c "airflow db init &&
                 airflow users create --username admin --firstname sophie --lastname b --role Admin --email admin@example.com --password admin &&
                 airflow webserver & airflow scheduler"
    ports: [ "8080:8080" ]


prometheus:
    image: prom/prometheus:latest
    volumes:
        - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports: [ "9090:9090" ]


grafana:
    image: grafana/grafana:latest
    ports: [ "3000:3000" ]
    environment:
        - GF_SECURIT_ADMIN_PASSWORD=admin